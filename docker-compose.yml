version: '2'

networks:
  appl:
    name: metal
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.0.0.0/24

volumes:
  nsq-data-volume:

services:
  nsqlookupd:
    image: nsqio/nsq:v1.1.0
    networks:
      - appl
    volumes:
      - nsq-data-volume:/data
    command: /nsqlookupd -log-level error
    ports:
      - "4160"
      - "4161"

  nsqd:
    image: nsqio/nsq:v1.1.0
    networks:
      - appl
    command: /nsqd -log-level error --lookupd-tcp-address=nsqlookupd:4160
    depends_on:
      - nsqlookupd
    ports:
      - "4150"
      - "4151"

  nsqadmin:
    image: nsqio/nsq:v1.1.0
    networks:
      - appl
    command: /nsqadmin -log-level error --lookupd-http-address=nsqlookupd:4161
    depends_on:
      - nsqlookupd
    ports:
      - "4171:4171"

  rethinkdb:
    image: rethinkdb
    networks:
      - appl
    ports:
      - "10080:8080"
      - "28015:28015"

  swagger:
    image: swaggerapi/swagger-ui
    networks:
      - appl
    ports:
     - "9099:8080"
    environment:
      API_URL: http://localhost:8080/apidocs.json

  metal-api:
    tty: true
    networks:
      - appl
    build:
      context: .
    image: registry.fi-ts.io/metal/metal-api
    ports:
      - "8080:8080"
    environment:
      METAL_API_BIND_ADDR: 0.0.0.0
      METAL_API_DB_ADDR: rethinkdb:28015
      METAL_API_NETBOX_ADDR: 10.0.0.1:8001
      METAL_API_NSQD_ADDR: nsqlookupd:4160
      METAL_API_NSQD_HTTP_ADDR: nsqlookupd:4161
      METAL_API_LOG_LEVEL: "debug"

  metal-core:
    networks:
      - appl
    image: registry.fi-ts.io/metal/metal-core
    container_name: metal-core
    environment:
      METAL_CORE_MQ_ADDRESS: nsqlookupd:4161
      METAL_CORE_IP: 127.0.0.1
      METAL_CORE_SITE_ID: FRA
      METAL_CORE_RACK_ID: Vagrant Rack 1
      METAL_CORE_LOG_LEVEL: DEBUG
      METAL_CORE_METAL_API_PORT: 8090
      METAL_CORE_HAMMER_IMAGE_PREFIX: metal-hammer
